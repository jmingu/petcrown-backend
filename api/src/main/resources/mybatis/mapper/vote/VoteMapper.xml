<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.api.vote.mapper.VoteMapper">

    <!-- Weekly 투표 등록 -->
    <insert id="insertVoteWeekly" useGeneratedKeys="true" keyProperty="voteWeeklyId">
        /*
        VoteMapper.xml
        insertVoteWeekly
        주간 투표 등록 (date_trunc 사용)
        */
        INSERT INTO vote_weekly (
            week_start_date, pet_id, vote_count, view_count, mode_id,
            create_date, create_user_id, update_date, update_user_id
        ) VALUES (
            #{weekStartDate}, #{petId}, #{voteCount}, #{viewCount}, #{modeId},
            #{createDate}, #{createUserId}, #{updateDate}, #{updateUserId}
        )
        RETURNING vote_weekly_id
    </insert>

    <!-- Monthly 투표 등록 -->
    <insert id="insertVoteMonthly" useGeneratedKeys="true" keyProperty="voteMonthlyId">
        /*
        VoteMapper.xml
        insertVoteMonthly
        월간 투표 등록
        */
        INSERT INTO vote_monthly (
            month_start_date, pet_id, vote_count, view_count, mode_id,
            create_date, create_user_id, update_date, update_user_id
        ) VALUES (
            #{monthStartDate}, #{petId}, #{voteCount}, #{viewCount}, #{modeId},
            #{createDate}, #{createUserId}, #{updateDate}, #{updateUserId}
        )
        RETURNING vote_monthly_id
    </insert>

    <!-- 투표 파일 정보 등록 -->
    <insert id="insertVoteFileInfo" useGeneratedKeys="true" keyProperty="voteFileId">
        /*
        VoteMapper.xml
        insertVoteFileInfo
        투표 파일 정보 등록
        */
        INSERT INTO vote_file_info (
            ref_table, ref_id, file_type, sort_order, file_url, file_size, mime_type,
            file_name, original_file_name,
            create_date, create_user_id, updated_date, update_user_id
        ) VALUES (
            CAST(#{refTable} AS ref_table_enum), #{refId}, CAST(#{fileType} AS file_type_enum), #{sortOrder}, #{fileUrl}, #{fileSize}, #{mimeType},
            #{fileName}, #{originalFileName},
            #{createDate}, #{createUserId}, #{updatedDate}, #{updateUserId}
        )
        RETURNING vote_file_id
    </insert>

    <!-- Weekly 투표 조회 (petId와 weekStartDate로) -->
    <select id="selectVoteWeeklyByPetIdAndWeek" resultType="kr.co.common.entity.vote.VoteWeeklyEntity">
        /*
        VoteMapper.xml
        selectVoteWeeklyByPetIdAndWeek
        주간 투표 조회
        */
        SELECT
            vote_weekly_id as voteWeeklyId,
            week_start_date as weekStartDate,
            pet_id as petId,
            vote_count as voteCount,
            view_count as viewCount,
            mode_id as modeId,
            create_date as createDate,
            create_user_id as createUserId,
            update_date as updateDate,
            update_user_id as updateUserId,
            delete_date as deleteDate,
            delete_user_id as deleteUserId
        FROM vote_weekly
        WHERE pet_id = #{petId}
        AND week_start_date = #{weekStartDate}
        AND delete_date IS NULL
    </select>

    <!-- Monthly 투표 조회 (petId와 monthStartDate로) -->
    <select id="selectVoteMonthlyByPetIdAndMonth" resultType="kr.co.common.entity.vote.VoteMonthlyEntity">
        /*
        VoteMapper.xml
        selectVoteMonthlyByPetIdAndMonth
        월간 투표 조회
        */
        SELECT
            vote_monthly_id as voteMonthlyId,
            month_start_date as monthStartDate,
            pet_id as petId,
            vote_count as voteCount,
            view_count as viewCount,
            mode_id as modeId,
            create_date as createDate,
            create_user_id as createUserId,
            update_date as updateDate,
            update_user_id as updateUserId,
            delete_date as deleteDate,
            delete_user_id as deleteUserId
        FROM vote_monthly
        WHERE pet_id = #{petId}
        AND month_start_date = #{monthStartDate}
        AND delete_date IS NULL
    </select>

    <!-- Weekly 투표 목록 조회 (현재 주) -->
    <select id="selectVoteWeeklyList" resultType="kr.co.api.vote.dto.command.VoteInfoDto">
        /*
        VoteMapper.xml
        selectVoteWeeklyList
        주간 투표 목록 조회
        */
        SELECT
            vw.vote_weekly_id as voteId,
            vw.pet_id as petId,
            p.user_id as userId,
            p.name as name,
            p.gender as gender,
            p.birth_date as birthDate,
            b.breed_id as breedId,
            b.name as breedName,
            s.species_id as speciesId,
            s.name as speciesName,
            pm.pet_mode_id as petModeId,
            pm.mode_name as petModeName,
            0 as dailyVoteCount,
            vw.vote_count as weeklyVoteCount,
            0 as monthlyVoteCount,
            vw.week_start_date as voteMonth,
            vfi.file_url as profileImageUrl,
            u.email as ownerEmail
        FROM vote_weekly vw
        INNER JOIN pet p ON vw.pet_id = p.pet_id AND p.delete_date IS NULL
        INNER JOIN "user" u ON p.user_id = u.user_id AND u.delete_date IS NULL
        LEFT JOIN breed b ON p.breed_id = b.breed_id
        LEFT JOIN species s ON b.species_id = s.species_id
        LEFT JOIN pet_mode pm ON vw.mode_id = pm.pet_mode_id AND pm.delete_date IS NULL
        LEFT JOIN vote_file_info vfi ON vfi.ref_table = 'vote_weekly'
            AND vfi.ref_id = vw.vote_weekly_id
            AND vfi.delete_date IS NULL
        WHERE vw.week_start_date = #{weekStartDate}
        AND vw.delete_date IS NULL
        ORDER BY vw.vote_count DESC, vw.vote_weekly_id DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Weekly 투표 목록 개수 -->
    <select id="selectVoteWeeklyListCount" resultType="int">
        /*
        VoteMapper.xml
        selectVoteWeeklyListCount
        주간 투표 목록 개수
        */
        SELECT COUNT(*)
        FROM vote_weekly vw
        INNER JOIN pet p ON vw.pet_id = p.pet_id AND p.delete_date IS NULL
        WHERE vw.week_start_date = #{weekStartDate}
        AND vw.delete_date IS NULL
    </select>

    <!-- Weekly 투표 상세 조회 -->
    <select id="selectVoteWeeklyDetail" resultType="kr.co.api.vote.dto.command.VoteInfoDto">
        /*
        VoteMapper.xml
        selectVoteWeeklyDetail
        주간 투표 상세 조회 (주간만)
        */
        SELECT
            vw.vote_weekly_id as voteId,
            vw.pet_id as petId,
            p.user_id as userId,
            p.name as name,
            p.gender as gender,
            p.birth_date as birthDate,
            b.breed_id as breedId,
            b.name as breedName,
            s.species_id as speciesId,
            s.name as speciesName,
            pm.pet_mode_id as petModeId,
            pm.mode_name as petModeName,
            0 as dailyVoteCount,
            vw.vote_count as weeklyVoteCount,
            0 as monthlyVoteCount,
            vw.week_start_date as voteMonth,
            vfi.file_url as profileImageUrl,
            u.email as ownerEmail
        FROM vote_weekly vw
        INNER JOIN pet p ON vw.pet_id = p.pet_id AND p.delete_date IS NULL
        INNER JOIN "user" u ON p.user_id = u.user_id AND u.delete_date IS NULL
        LEFT JOIN pet_mode pm ON vw.mode_id = pm.pet_mode_id AND pm.delete_date IS NULL
        LEFT JOIN breed b ON p.breed_id = b.breed_id
        LEFT JOIN species s ON b.species_id = s.species_id
        LEFT JOIN vote_file_info vfi ON vfi.ref_table = 'vote_weekly'
            AND vfi.ref_id = vw.vote_weekly_id
            AND vfi.delete_date IS NULL
        WHERE vw.vote_weekly_id = #{voteId}
        AND vw.delete_date IS NULL
    </select>

    <!-- Monthly 투표 목록 조회 (현재 월) -->
    <select id="selectVoteMonthlyList" resultType="kr.co.api.vote.dto.command.VoteInfoDto">
        /*
        VoteMapper.xml
        selectVoteMonthlyList
        월간 투표 목록 조회
        */
        SELECT
            vm.vote_monthly_id as voteId,
            vm.pet_id as petId,
            p.user_id as userId,
            p.name as name,
            p.gender as gender,
            p.birth_date as birthDate,
            b.breed_id as breedId,
            b.name as breedName,
            s.species_id as speciesId,
            s.name as speciesName,
            0 as dailyVoteCount,
            0 as weeklyVoteCount,
            vm.vote_count as monthlyVoteCount,
            vm.month_start_date as voteMonth,
            vfi.file_url as profileImageUrl,
            u.email as ownerEmail
        FROM vote_monthly vm
        INNER JOIN pet p ON vm.pet_id = p.pet_id AND p.delete_date IS NULL
        INNER JOIN "user" u ON p.user_id = u.user_id AND u.delete_date IS NULL
        LEFT JOIN breed b ON p.breed_id = b.breed_id
        LEFT JOIN species s ON b.species_id = s.species_id
        LEFT JOIN vote_file_info vfi ON vfi.ref_table = 'vote_monthly'
            AND vfi.ref_id = vm.vote_monthly_id
            AND vfi.delete_date IS NULL
        WHERE vm.month_start_date = #{monthStartDate}
        AND vm.delete_date IS NULL
        ORDER BY vm.vote_count DESC, vm.vote_monthly_id DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- Monthly 투표 목록 개수 -->
    <select id="selectVoteMonthlyListCount" resultType="int">
        /*
        VoteMapper.xml
        selectVoteMonthlyListCount
        월간 투표 목록 개수
        */
        SELECT COUNT(*)
        FROM vote_monthly vm
        INNER JOIN pet p ON vm.pet_id = p.pet_id AND p.delete_date IS NULL
        WHERE vm.month_start_date = #{monthStartDate}
        AND vm.delete_date IS NULL
    </select>

    <!-- Monthly 투표 상세 조회 -->
    <select id="selectVoteMonthlyDetail" resultType="kr.co.api.vote.dto.command.VoteInfoDto">
        /*
        VoteMapper.xml
        selectVoteMonthlyDetail
        월간 투표 상세 조회 (월간만)
        */
        SELECT
            vm.vote_monthly_id as voteId,
            vm.pet_id as petId,
            p.user_id as userId,
            p.name as name,
            p.gender as gender,
            p.birth_date as birthDate,
            b.breed_id as breedId,
            b.name as breedName,
            s.species_id as speciesId,
            s.name as speciesName,
            0 as dailyVoteCount,
            0 as weeklyVoteCount,
            vm.vote_count as monthlyVoteCount,
            vm.month_start_date as voteMonth,
            vfi.file_url as profileImageUrl,
            u.email as ownerEmail
        FROM vote_monthly vm
        INNER JOIN pet p ON vm.pet_id = p.pet_id AND p.delete_date IS NULL
        INNER JOIN "user" u ON p.user_id = u.user_id AND u.delete_date IS NULL
        LEFT JOIN breed b ON p.breed_id = b.breed_id
        LEFT JOIN species s ON b.species_id = s.species_id
        LEFT JOIN vote_file_info vfi ON vfi.ref_table = 'vote_monthly'
            AND vfi.ref_id = vm.vote_monthly_id
            AND vfi.delete_date IS NULL
        WHERE vm.vote_monthly_id = #{voteMonthlyId}
        AND vm.delete_date IS NULL
    </select>

    <!-- Weekly 투표 카운트 증가 -->
    <update id="updateVoteWeeklyCount">
        /*
        VoteMapper.xml
        updateVoteWeeklyCount
        주간 투표 카운트 증가
        */
        UPDATE vote_weekly
        SET
            vote_count = vote_count + 1,
            update_date = CURRENT_TIMESTAMP,
            update_user_id = #{updateUserId}
        WHERE vote_weekly_id = #{voteWeeklyId}
    </update>

    <!-- Monthly 투표 카운트 증가 -->
    <update id="updateVoteMonthlyCount">
        /*
        VoteMapper.xml
        updateVoteMonthlyCount
        월간 투표 카운트 증가
        */
        UPDATE vote_monthly
        SET
            vote_count = vote_count + 1,
            update_date = CURRENT_TIMESTAMP,
            update_user_id = #{updateUserId}
        WHERE vote_monthly_id = #{voteMonthlyId}
    </update>

    <!-- Weekly 투표 삭제 (논리 삭제) -->
    <update id="deleteVoteWeekly">
        /*
        VoteMapper.xml
        deleteVoteWeekly
        주간 투표 삭제
        */
        UPDATE vote_weekly
        SET
            delete_date = CURRENT_TIMESTAMP,
            delete_user_id = #{deleteUserId}
        WHERE vote_weekly_id = #{voteWeeklyId}
    </update>

    <!-- Monthly 투표 삭제 (논리 삭제) -->
    <update id="deleteVoteMonthly">
        /*
        VoteMapper.xml
        deleteVoteMonthly
        월간 투표 삭제
        */
        UPDATE vote_monthly
        SET
            delete_date = CURRENT_TIMESTAMP,
            delete_user_id = #{deleteUserId}
        WHERE vote_monthly_id = #{voteMonthlyId}
    </update>

    <!-- 투표 파일 정보 수정 -->
    <update id="updateVoteFileInfo">
        /*
        VoteMapper.xml
        updateVoteFileInfo
        투표 파일 정보 수정
        */
        UPDATE vote_file_info
        SET
            file_url = #{fileUrl},
            file_size = #{fileSize},
            mime_type = #{mimeType},
            file_name = #{fileName},
            original_file_name = #{originalFileName},
            updated_date = CURRENT_TIMESTAMP,
            update_user_id = #{updateUserId}
        WHERE ref_table = CAST(#{refTable} AS ref_table_enum)
        AND ref_id = #{refId}
        AND delete_date IS NULL
    </update>

    <!-- 투표 파일 정보 삭제 (논리 삭제) -->
    <update id="deleteVoteFileInfo">
        /*
        VoteMapper.xml
        deleteVoteFileInfo
        투표 파일 정보 삭제
        */
        UPDATE vote_file_info
        SET
            delete_date = CURRENT_TIMESTAMP,
            delete_user_id = #{deleteUserId}
        WHERE ref_table = CAST(#{refTable} AS ref_table_enum)
        AND ref_id = #{refId}
    </update>

    <!-- 사용자의 현재 주 투표 등록 수 조회 -->
    <select id="countWeeklyVoteRegistrationByUser" resultType="int">
        /*
        VoteMapper.xml
        countWeeklyVoteRegistrationByUser
        사용자의 현재 주 투표 등록 수 조회 (date_trunc 사용)
        */
        SELECT COUNT(*)
        FROM vote_weekly vw
        INNER JOIN pet p ON vw.pet_id = p.pet_id
        WHERE p.user_id = #{userId}
        AND date_trunc('week', vw.week_start_date) = date_trunc('week', CURRENT_DATE)
        AND vw.delete_date IS NULL
    </select>

    <!-- Weekly 투표 수정 (파일 URL) -->
    <update id="updateVoteWeekly">
        /*
        VoteMapper.xml
        updateVoteWeekly
        주간 투표 수정
        */
        UPDATE vote_weekly
        SET
            update_date = CURRENT_TIMESTAMP,
            update_user_id = #{updateUserId}
        WHERE vote_weekly_id = #{voteWeeklyId}
    </update>

    <!-- 현재 주의 weekStartDate 조회 (date_trunc 사용) -->
    <select id="selectCurrentWeekStartDate" resultType="java.time.LocalDate">
        /*
        VoteMapper.xml
        selectCurrentWeekStartDate
        현재 주의 weekStartDate 조회
        */
        SELECT date_trunc('week', CURRENT_DATE)::date AS weekStartDate
    </select>

</mapper>
