<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.api.event.mapper.EventMapper">

    <insert id="insertEvent" useGeneratedKeys="true" keyProperty="eventId">
        /*
        EventMapper.xml
        insertEvent
        이벤트 저장
        */
        INSERT INTO event (
            title, content, content_type,
            start_date, end_date, view_count,
            create_date, create_user_id, updated_date, update_user_id
        ) VALUES (
            #{title}, #{content}, #{contentType},
            #{startDate}, #{endDate}, #{viewCount},
            CURRENT_TIMESTAMP, #{createUserId}, CURRENT_TIMESTAMP, #{createUserId}
        )
        RETURNING event_id
    </insert>

    <select id="selectByEventId" resultType="kr.co.common.entity.event.EventEntity">
        /*
        EventMapper.xml
        selectByEventId
        이벤트 ID로 조회
        */
        SELECT *
        FROM event
        WHERE event_id = #{eventId}
        AND delete_date IS NULL
    </select>

    <select id="selectActiveEvents" resultType="kr.co.common.entity.event.EventEntity">
        /*
        EventMapper.xml
        selectActiveEvents
        활성화된 이벤트 목록 조회 (페이징)
        */
        SELECT *
        FROM event
        WHERE delete_date IS NULL
        AND start_date <![CDATA[<=]]> CURRENT_TIMESTAMP
        AND (end_date IS NULL OR end_date >= CURRENT_TIMESTAMP)
        ORDER BY create_date DESC
        OFFSET #{offset} LIMIT #{limit}
    </select>

    <select id="selectAllEvents" resultType="kr.co.common.entity.event.EventEntity">
        /*
        EventMapper.xml
        selectAllEvents
        전체 이벤트 목록 조회 (관리자용)
        */
        SELECT *
        FROM event
        WHERE delete_date IS NULL
        ORDER BY create_date DESC
        OFFSET #{offset} LIMIT #{limit}
    </select>

    <select id="countActiveEvents" resultType="int">
        /*
        EventMapper.xml
        countActiveEvents
        활성화된 이벤트 개수 조회
        */
        SELECT COUNT(*)
        FROM event
        WHERE delete_date IS NULL
        AND start_date <![CDATA[<=]]> CURRENT_TIMESTAMP
        AND (end_date IS NULL OR end_date >= CURRENT_TIMESTAMP)
    </select>

    <select id="countAllEvents" resultType="int">
        /*
        EventMapper.xml
        countAllEvents
        전체 이벤트 개수 조회
        */
        SELECT COUNT(*)
        FROM event
        WHERE delete_date IS NULL
    </select>

    <update id="updateEvent">
        /*
        EventMapper.xml
        updateEvent
        이벤트 수정
        */
        UPDATE event SET
            title = #{title},
            content = #{content},
            content_type = #{contentType},
            start_date = #{startDate},
            end_date = #{endDate},
            updated_date = CURRENT_TIMESTAMP,
            update_user_id = #{updateUserId}
        WHERE event_id = #{eventId}
        AND delete_date IS NULL
    </update>

    <update id="incrementViewCount">
        /*
        EventMapper.xml
        incrementViewCount
        조회수 증가
        */
        UPDATE event SET
            view_count = view_count + 1,
            updated_date = CURRENT_TIMESTAMP
        WHERE event_id = #{eventId}
        AND delete_date IS NULL
    </update>

    <update id="deleteById">
        /*
        EventMapper.xml
        deleteById
        이벤트 삭제 (논리 삭제)
        */
        UPDATE event SET
            delete_date = CURRENT_TIMESTAMP,
            delete_user_id = #{deleteUserId}
        WHERE event_id = #{eventId}
    </update>

    <select id="searchByTitle" resultType="kr.co.common.entity.event.EventEntity">
        /*
        EventMapper.xml
        searchByTitle
        제목으로 이벤트 검색
        */
        SELECT *
        FROM event
        WHERE delete_date IS NULL
        AND title ILIKE '%' || #{title} || '%'
        AND start_date <![CDATA[<=]]> CURRENT_TIMESTAMP
        AND (end_date IS NULL OR end_date >= CURRENT_TIMESTAMP)
        ORDER BY create_date DESC
        OFFSET #{offset} LIMIT #{limit}
    </select>

    <select id="countSearchByTitle" resultType="int">
        /*
        EventMapper.xml
        countSearchByTitle
        제목으로 검색된 이벤트 개수
        */
        SELECT COUNT(*)
        FROM event
        WHERE delete_date IS NULL
        AND title ILIKE '%' || #{title} || '%'
        AND start_date <![CDATA[<=]]> CURRENT_TIMESTAMP
        AND (end_date IS NULL OR end_date >= CURRENT_TIMESTAMP)
    </select>

</mapper>
