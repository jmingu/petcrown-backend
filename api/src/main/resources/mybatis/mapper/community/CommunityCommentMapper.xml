<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.api.community.mapper.CommunityCommentMapper">

    <insert id="insertComment" useGeneratedKeys="true" keyProperty="commentId">
        /*
        CommunityCommentMapper.xml
        insertComment
        댓글 저장
        */
        INSERT INTO community_comment (
            post_id, user_id, parent_comment_id, content, like_count, depth,
            create_date, create_user_id, update_date, update_user_id
        ) VALUES (
            #{postId}, #{userId}, #{parentCommentId}, #{content}, #{likeCount}, #{depth},
            CURRENT_TIMESTAMP, #{createUserId}, CURRENT_TIMESTAMP, #{createUserId}
        )
        RETURNING comment_id
    </insert>

    <select id="selectByCommentId" resultType="kr.co.common.entity.community.CommunityCommentQueryDto">
        /*
        CommunityCommentMapper.xml
        selectByCommentId
        댓글 ID로 조회
        */
        SELECT
            cc.comment_id,
            cc.post_id,
            cc.user_id,
            u.nickname as nickname,
            cc.parent_comment_id,
            cc.content,
            cc.like_count,
            cc.depth,
            cc.create_date,
            cc.create_user_id,
            cc.update_date,
            cc.update_user_id,
            cc.delete_date,
            cc.delete_user_id
        FROM community_comment cc
        LEFT JOIN "user" u ON cc.user_id = u.user_id
        WHERE cc.comment_id = #{commentId}
        AND cc.delete_date IS NULL
    </select>

    <select id="selectByPostId" resultType="kr.co.common.entity.community.CommunityCommentQueryDto">
        /*
        CommunityCommentMapper.xml
        selectByPostId
        게시글의 모든 댓글 조회 (최상위 댓글만)
        */
        SELECT
            cc.comment_id,
            cc.post_id,
            cc.user_id,
            u.nickname as nickname,
            cc.parent_comment_id,
            cc.content,
            cc.like_count,
            cc.depth,
            cc.create_date,
            cc.create_user_id,
            cc.update_date,
            cc.update_user_id,
            cc.delete_date,
            cc.delete_user_id
        FROM community_comment cc
        LEFT JOIN "user" u ON cc.user_id = u.user_id
        WHERE cc.post_id = #{postId}
        AND cc.parent_comment_id IS NULL
        AND cc.delete_date IS NULL
        ORDER BY cc.create_date ASC
    </select>

    <select id="selectRepliesByParentCommentId" resultType="kr.co.common.entity.community.CommunityCommentQueryDto">
        /*
        CommunityCommentMapper.xml
        selectRepliesByParentCommentId
        특정 댓글의 대댓글 조회
        */
        SELECT
            cc.comment_id,
            cc.post_id,
            cc.user_id,
            u.nickname as nickname,
            cc.parent_comment_id,
            cc.content,
            cc.like_count,
            cc.depth,
            cc.create_date,
            cc.create_user_id,
            cc.update_date,
            cc.update_user_id,
            cc.delete_date,
            cc.delete_user_id
        FROM community_comment cc
        LEFT JOIN "user" u ON cc.user_id = u.user_id
        WHERE cc.parent_comment_id = #{parentCommentId}
        AND cc.delete_date IS NULL
        ORDER BY cc.create_date ASC
    </select>

    <select id="countByPostId" resultType="int">
        /*
        CommunityCommentMapper.xml
        countByPostId
        게시글의 전체 댓글 개수 조회
        */
        SELECT COUNT(*)
        FROM community_comment
        WHERE post_id = #{postId}
        AND delete_date IS NULL
    </select>

    <update id="updateComment">
        /*
        CommunityCommentMapper.xml
        updateComment
        댓글 수정
        */
        UPDATE community_comment SET
            content = #{content},
            update_date = CURRENT_TIMESTAMP,
            update_user_id = #{updateUserId}
        WHERE comment_id = #{commentId}
        AND delete_date IS NULL
    </update>

    <update id="incrementLikeCount">
        /*
        CommunityCommentMapper.xml
        incrementLikeCount
        댓글 좋아요 수 증가
        */
        UPDATE community_comment SET
            like_count = like_count + 1,
            update_date = CURRENT_TIMESTAMP
        WHERE comment_id = #{commentId}
        AND delete_date IS NULL
    </update>

    <update id="deleteById">
        /*
        CommunityCommentMapper.xml
        deleteById
        댓글 삭제 (논리 삭제)
        */
        UPDATE community_comment SET
            delete_date = CURRENT_TIMESTAMP,
            delete_user_id = #{deleteUserId}
        WHERE comment_id = #{commentId}
    </update>

</mapper>
